import os
from dotenv import load_dotenv
from crewai import LLM, Agent, Task
from pydantic import BaseModel, Field

load_dotenv()

llm = LLM(
    model="openai/mws-gpt-alpha",
    api_key=os.getenv("MWS_API_KEY"),
    base_url=os.getenv("MWS_BASE_URL"),
    temperature=0.2,
)

emotion_examples = {
    "anger": [
        "Это уже невозможно терпеть!",
        "Вы меня совсем не слышите!",
        "Сколько можно это игнорировать?",
        "Вы издеваетесь?",
        "Мне надоело ваше бездействие!",
        "Почему вы так со мной обращаетесь?",
        "Я зол на ваше отношение!",
        "Как можно так работать?",
        "Никакого уважения к клиенту!",
        "Ваш сервис отвратителен!",
        "Я просто в бешенстве!",
        "Каждый раз одно и то же!",
        "Вы испортили мне день!",
        "У вас нет совести!",
        "Это нарушение всех границ!",
        "Я больше не намерен это терпеть!",
        "Это последнее предупреждение!",
        "Раздражает до невозможности!",
        "Я не собираюсь молчать!",
        "Будьте добры, исправьте ситуацию — срочно!",
    ],
    "frustration": [
        "Я уже сто раз писал, и всё без ответа.",
        "Очень утомительно каждый раз объяснять одно и то же.",
        "Сколько можно ждать?",
        "Я просто устал от этого.",
        "Кажется, никто не хочет помочь.",
        "Это невыносимо долго.",
        "Ситуация не меняется!",
        "Я больше не знаю, что делать.",
        "Почему всё так сложно?",
        "Мне надоело бороться с этим.",
        "Каждый шаг — как через тернии.",
        "Неужели нельзя проще?",
        "Опять то же самое!",
        "И снова ошибка!",
        "Так нельзя работать.",
        "Все мои усилия напрасны.",
        "Ничего не решается.",
        "Я отчаялся уже.",
        "Как же это бесит...",
        "Всё идёт не так, как надо.",
    ],
    "sadness": [
        "Жаль, что так получилось...",
        "Мне очень грустно, что вы не смогли помочь.",
        "Я чувствую себя одиноко в этой ситуации.",
        "Разочарован результатом.",
        "Очень обидно.",
        "Такого я не ожидал...",
        "Мне правда тяжело сейчас.",
        "Печально видеть такое отношение.",
        "Я расстроен всей ситуацией.",
        "Это ранит.",
        "Сердце сжимается от этого.",
        "Мне больно это признавать.",
        "Потерял надежду.",
        "С каждым днём всё грустнее.",
        "Жалко потраченное время.",
        "Печально, что всё развалилось.",
        "Это оставляет осадок.",
        "Никакой радости от этого.",
        "Жаль, что всё вышло так.",
        "Мечты разбились о реальность.",
    ],
    "fear": [
        "Я боюсь, что потеряю деньги.",
        "Это точно безопасно?",
        "Что, если что-то пойдёт не так?",
        "Мне страшно принимать это решение.",
        "У меня плохое предчувствие.",
        "Я не уверен, стоит ли рисковать.",
        "Может случиться беда.",
        "Боюсь за последствия.",
        "Это вызывает тревогу.",
        "У меня внутреннее беспокойство.",
        "Ситуация кажется опасной.",
        "Не знаю, к чему это приведёт.",
        "Я волнуюсь об этом.",
        "А вдруг я ошибся?",
        "Меня мучают сомнения.",
        "Что, если всё разрушится?",
        "Я не готов к такому риску.",
        "Кажется, это угроза.",
        "Становится не по себе.",
        "Я не справлюсь один.",
    ],
    "happy": [
        "Спасибо огромное, вы супер!",
        "Очень рад, что всё получилось!",
        "Это лучший день!",
        "В восторге от вашего сервиса!",
        "Вы сделали меня счастливым!",
        "Чудесно, просто прекрасно!",
        "Спасибо за помощь!",
        "Я улыбаюсь до ушей!",
        "Супер, даже не ожидал!",
        "Настроение поднялось!",
        "Это то, что нужно!",
        "Вы молодцы!",
        "Благодарю от всего сердца!",
        "Это так приятно!",
        "Вы сделали мой день!",
        "Мне всё очень понравилось!",
        "Вы великолепны!",
        "Невероятно круто!",
        "Я доволен на 100%!",
        "Рад, что выбрал вас!",
    ],
    "satisfaction": [
        "Всё прошло отлично, благодарю!",
        "Я доволен вашим сервисом.",
        "Отличный результат!",
        "Так держать!",
        "Это именно то, что я хотел.",
        "Приятно работать с вами.",
        "Было удобно и понятно.",
        "Вы профессионалы.",
        "Я получил то, что ожидал.",
        "Работа выполнена качественно.",
        "Без нареканий, всё на уровне.",
        "Всё сделано вовремя.",
        "Хорошее впечатление осталось.",
        "Выдержано обещание.",
        "Достойный подход к делу.",
        "Всё честно и прозрачно.",
        "Отличный сервис!",
        "Я это ценю.",
        "Оправдали ожидания.",
        "Спасибо, всё чётко!",
    ],
    "confusion": [
        "А вы можете объяснить поподробнее?",
        "Не понял, что вы имеете в виду.",
        "Я немного запутался.",
        "Можете уточнить детали?",
        "Что вы хотите этим сказать?",
        "Непонятно, как действовать дальше.",
        "Мне нужна ясность.",
        "Можете привести пример?",
        "Что вы имеете в виду под этим?",
        "Как это вообще работает?",
        "Мне сложно это уловить.",
        "Поясните, пожалуйста.",
        "Уточните шаги, пожалуйста.",
        "Не уверен, что всё правильно понял.",
        "Что именно нужно сделать?",
        "Путаюсь в этих понятиях.",
        "Можете переформулировать?",
        "Нужна дополнительная информация.",
        "Что означает эта часть?",
        "Проясните ситуацию, пожалуйста.",
    ],
    "urgency": [
        "Мне нужно срочно решить этот вопрос!",
        "У меня дедлайн, давайте быстрее!",
        "Времени совсем нет!",
        "Прошу поторопиться!",
        "Ситуация критическая!",
        "Это не терпит отлагательств!",
        "Нужно немедленно разобраться!",
        "Очень срочная задача!",
        "Каждая минута на счету!",
        "Это вопрос часов!",
        "Действовать надо сейчас!",
        "Пожалуйста, быстрее!",
        "Я не могу ждать дольше!",
        "Поторопитесь, пожалуйста!",
        "Ситуация выходит из-под контроля!",
        "Всё висит на волоске!",
        "От этого многое зависит!",
        "Прошу вас, ускорьтесь!",
        "Это приоритет номер один!",
        "Очень важное и срочное дело!",
    ],
    "neutral": [
        "Хорошо, жду информации.",
        "Окей, принял к сведению.",
        "Понятно.",
        "Спасибо за ответ.",
        "Принято.",
        "Хорошо, будем ждать.",
        "Ожидаю дальнейших инструкций.",
        "Спасибо, посмотрю.",
        "Хорошо, понял.",
        "Прочитал, всё ясно.",
        "Уточните, когда будет готово.",
        "Ожидаю обновлений.",
        "Просто хочу уточнить.",
        "Пока вопросов нет.",
        "Спасибо за информацию.",
        "Буду на связи.",
        "Сообщите, когда появятся новости.",
        "Просто фиксирую для себя.",
        "Дайте знать, если что-то изменится.",
        "Понял, без эмоций.",
    ],
    "excitement": [
        "Ура! Это круто!",
        "Обожаю вашу компанию, спасибо!",
        "Вау, это просто огонь!",
        "Супер, не ожидал!",
        "Я так рад!",
        "Это шикарно!",
        "Как же круто!",
        "Вы превзошли все ожидания!",
        "Я в восторге!",
        "Это невероятно!",
        "Фантастика!",
        "Очень крутая новость!",
        "Потрясающе!",
        "Вдохновляет!",
        "Это прямо мечта!",
        "Офигенно!",
        "Больше такого, пожалуйста!",
        "Мурашки по коже!",
        "Эмоции зашкаливают!",
        "Это победа!",
    ],
}



class EmotionResponse(BaseModel):
    emotion: str = Field(..., pattern=f"^({'|'.join(emotion_examples.keys())})$")


def parse_emotion_output(output: str) -> EmotionResponse:
    import json

    try:
        data = json.loads(output)
        return EmotionResponse(**data)
    except json.JSONDecodeError:
        # Handle invalid JSON
        return EmotionResponse(emotion="neutral")


emotion_agent = Agent(
    role="Emotion Agent",
    goal="Определять эмоцию (например: happy, neutral, anger) в сообщении клиента.",
    backstory="Психолог‑аналитик, обученный распознавать эмоциональные состояния клиентов",
    llm=llm,
)

emotion_task = Task(
    description=(
        'Прочитай сообщение и верни JSON: {"emotion": "<твоя_метка>"}.'
        'Ты — аналитик эмоций. Прочитай сообщение клиента и верни JSON: {"emotion": "<твоя_метка>"}.\n'
        "Возможные значения:\n"
        "- neutral — нейтральный тон\n"
        "- happy — радость, благодарность\n"
        "- anger — раздражение, злость, агрессия\n"
        "- frustration — усталость от проблемы, негодование\n"
        "- sadness — печаль, разочарование\n"
        "- fear — тревога, обеспокоенность\n"
        "- satisfaction — довольство, одобрение\n"
        "- confusion — непонимание, замешательство\n"
        "- urgency — срочность, стресс\n"
        "- excitement — воодушевление, положительное волнение"
        + "\n".join(
            [
                f"- {emotion} → " + " / ".join(examples)
                for emotion, examples in emotion_examples.items()
            ]
        )
    ),
    expected_output='JSON с ключом "emotion" . Строго в формате JSON без пояснений!',
    agent=emotion_agent,
    output_json=EmotionResponse,
    parse_output=parse_emotion_output,
)
